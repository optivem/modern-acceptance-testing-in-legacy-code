import { useState, useEffect, useCallback } from 'react';
import { browseCoupons, createCoupon } from '../services/coupon-service';
import type { BrowseCouponsItemResponse } from '../types/api.types';
import type { CouponFormData } from '../features/coupons';

/**
 * Custom hook for managing coupons (browsing and creation)
 * @returns Coupon state, loading states, and control functions
 */
export function useCoupons() {
  const [coupons, setCoupons] = useState<BrowseCouponsItemResponse[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  const loadCoupons = useCallback(async () => {
    setIsLoading(true);
    setError(null);

    const result = await browseCoupons();

    if (result.success) {
      setCoupons(result.data.coupons);
    } else {
      setError('Failed to load coupons');
    }
    setIsLoading(false);
  }, []);

  useEffect(() => {
    loadCoupons();
  }, [loadCoupons]);

  const generateCouponCode = (): string => {
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    return `SAVE${randomNum}`;
  };

  const submitCoupon = async (formData: CouponFormData) => {
    setError(null);
    setIsCreating(true);

    // Convert datetime-local to ISO 8601 string, treating input as UTC
    const validFrom = formData.validFrom && formData.validFrom.trim()
      ? formData.validFrom + 'Z'
      : null;
    const validTo = formData.validTo && formData.validTo.trim()
      ? formData.validTo + 'Z'
      : null;

    const result = await createCoupon(
      formData.code,
      formData.discountRate,
      validFrom,
      validTo,
      formData.usageLimit ? parseInt(formData.usageLimit) : null
    );

    setIsCreating(false);

    if (result.success) {
      // Small delay to ensure backend transaction is committed before reloading
      setTimeout(async () => {
        await loadCoupons();
      }, 100);
    }

    return result;
  };

  const getCouponStatus = (coupon: BrowseCouponsItemResponse): string => {
    const now = new Date();
    const validFrom = coupon.validFrom ? new Date(coupon.validFrom) : null;
    const validTo = coupon.validTo ? new Date(coupon.validTo) : null;

    if (validFrom && now < validFrom) {
      return 'Not Yet Valid';
    } else if (validTo && now > validTo) {
      return 'Expired';
    } else if (coupon.usageLimit !== null && coupon.usedCount >= coupon.usageLimit) {
      return 'Limit Reached';
    }
    return 'Active';
  };

  return {
    coupons,
    isLoading,
    error,
    isCreating,
    submitCoupon,
    generateCouponCode,
    getCouponStatus,
    refresh: loadCoupons
  };
}
